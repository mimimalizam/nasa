## Adding private SSH key to project as a secret

### Steps for creating a secret

- Generate base64 representation of private key content

```
cat ~/.ssh/id_rsa_example_repo | base64  -w 0
```

- Create a Semaphore secret yaml file and add this string to it

```
$ cat secret_with_private_ssh_key.yml
apiVersion: v1alpha
kind: Secret
metadata:
  name: ssh-key-example-repo
data:
  env_vars:
    - name: SSH_KEY
      value: AS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlKS1FJQkFBS0NBZ0VBbjZ6TFc1Wm9DZ0dDZTN4WjBKREd1U05HWW9TRG1ScGdkcFFGTWNjNERDZWRiRlhVCjRzWmJFa1M2ZEM0TGJQbk1pOFd5YjFpbU9TTU1wUWkxUzNQY2ZTUXJMMjJGVUFJSit5NFF6TWtCQm4raE5ZT2wKQTk4UjdYWFZ2T1FnbG1jckhPZGg2bGFjWmNqZWM2dmRrWlhvemhrZDhKWmhtaGg3MUFWcVVRN3FUc3p0ckZHTAp2OWhpMmFLd1BUNHEwUlhZdkw1YkNzYXlWSXVHclNqSWt6VUVRRUJTS2xMSVoyTXBERENoQTE3cHMvK2c3MllwCjRqcGUrV1ZOWmNPMWlyQ0k3dm0yWkpKQThhbU9Qd2xQbjlMb040RVJEZ0tNNHJXN2s0aklJczFGa1o4SEVwL28KN0VtUXViTnZGTkc4bDR1R1FXajZ4MGtnNy9rU0tsVnNlbkZ3RmZScCtYNTZRd20wNVNKOWFyb1pMT3FJVjBUbAp3bmhud1VSMXVHcGdPMVFIYkdjdXI0WnZSV1JsUWY1TjRuUnZVM3pPcCtUZDR0d1JvL1R4cnNNL3J2Q1FSWS85CmI4TUJ0OTh4eDdLSFA1djF4dllDWWJtZWd6dWRLU1J5eFE3YmlJN1pSWEs5NXJLK2UrUWJuYi9TeENyTnlaV28KU0ozM2RXRWN4RDV4aFZISnZ2cm0wNEZmYVZNMjdyMC9HZHB0ekgrVzloK2EzczhmV2g4VWZNNUZyYXVOMlhmWQp3MGNrbkErTjAwcnNKR0dOYTFxRUxOblpUajE2cVBNcm5lN2kzWXFhREYxWThIcmE2aHlNdWlDbEpzK2hqY3FnCndnTmJ5VHV1bU5VOWYzQ2EwYlVPWm9Pb3N4citPNGNZcEJjUkNBV1BMVVB4LzBXQnl5TFlsSElrMC9NQ0F3RUEKQVFLQ0FnRUFubkhRdVdsZWc4OUxzMDJKc2pSM2ZXOUxnS2NPRHZibGtjVUFBbzAxU0pwbTFBRzM1ZS8rbnZvawpLdlVsMFZWdmE2TVpsUFBhdmdmUm5GSXYxRmQ4QzVIQWFLZTlDYzk4S0F0bUVFL0UvTFhaT2trUGplL2swa1dECmVwVEU0WG91aGRmMGlaeTRSU2cxMVlKTnN4R1dtaXpDVU9Kb3A0aDBGOGZuMzlkMUdneXdLN1lmZnBjeVA5UDQKSGsxNkgxQVdhZlJhVXk4bjlrMGRydVl4WWlIUnZoQVZlSG44OHRxcStMV29rTGUySUM4aGUyMWRVbWVwcHNDbgpOTHduZ1IvOFFXYjVYb0xpZnV0Smc3T3hsMTZwbjZvclNrT3RtYW5NSUhJeVpwWmEyazE3cnplTzRpbDl1MGdhCmlnWTFwZ3VGaFpLdWh1SkNGTjZLOEFja1Jid2JBNXptM09McHYxc2ZVdHYzbVNTZTlNdUZ5aXRwcG9HTDNkdXMKM1BPZU16NnhhanFFSmI3VTdIZ0VHbUVWVkpuRFo1aWRkblN0eUF3SGNISWswbkVlZ1JlRzZjc0dGOXZ1WlhLbwpXamNidGNDTjMyZzNhOWZVNGcwRVptdmc0VmxlQnQrOWc5WE9WY3h6OFNDVXMycFVwcVhLQW1zSGNNcW85Q2dKCnN3bUVpb0MwNGYvaURzQ3VtVzdReGU1SE8yQXNGNnMrUFc0UkFkVHNFQUtUNWtTUUY4eG1MUzBnZ1JsNTVtR0sKbnpEL1FYejRKNWl2Z3VBV3krNVB0eC9CTEJUTllYNFg4bk9EbDdYOHNJOVo2a3dyRmZla01lVHdqY3ZsWGYzMgpKbFhWU3pFeWRQTzVrZk16cHNBakpoRFNPdjUyd01kWWl1d3lGcUwyZ1puc05VMGlvSUVDZ2dFQkFNeG8raU1ZCkhUNE5WOGJsN2hDWmUyN0hyRmVXWWYxVEFBbnNmYzBIYmlyenhocTF4Y25Ec3IzZ1lqaHVoaUtBY1lWVTE5UWYKNk11bDBSTmpDUmVoU1lWbzBZYUhyQnlVRkFrKzZZSVVrWkxHY1B4dHZYdUUrSEFTME4wYlJ0U1RSRGp5ckJKOApMbWtPZXp1Vll0cm9jTFRWRzVub3p1SUJsbjlSamhlYmk3YzFRdTVpRjlTaXdCYldCU2liaXZ4RGhFaXFPL0lECjhYRXZ3aVRpeWVoaGNQLzl4TDhNdkk4M3FDcVpjZmJ2L2hMRFc1Zjg4KzdvTGZzZURtdkE3OWgrbVlUQ3JOSS8KekI0ZlpLYW9ybEJPUzNYcUtxcTRVai9hMndNbStCSndPN2F0Um1MeDFORm1TVHBXRFhTSUtCNEcvdkNUNjdvUQorT3ZDMmQyblJlblM5anNDZ2dFQkFNZjVkcnlpK3lyY1R6NEN5czhocnZ4YlJaeWt2cUU5Z2c2Z0R1N2VKTkRCCkd0NEpIVjlaTFNHMjE4RGwyMjBVVWxDa1RLUGJYelc5ejlIeXBmWkFZaDZneVpmMmJoUHUrUlM0cHJPL1Ard2kKaE1lamZXcG9DM2IxWDQxaUZkcU1ha0xNbXA5ajE5MFFhT0V2OVF4ZjhndSs1QUVRRkpyQ3czTEswazhOa3d0cgpRQ25hYmNDV1k4WTJFSG9xUm5BcVFGQUlQN0FoZmtWSksyWEpuU0tWWFFiRnJLaWVmdHAxOGIxRlA4NWVwYjF5ClJsMHdtdFFhZmEwck8rV2o0dUJZWmwzN2Rndnd3YURGRWJYM3VPY0dJa3Fua25QemNyVFk2WXYvMFJYMVdaNkoKK1NRamliM1RsYnMwakRmeHg3VnpPTzBUWHI2ajR5ZG1ydkl3Rk9XQlpha0NnZ0VCQUx1ZTE0bUN4c1NBQnNOLwpwS1lEMnJIeUFKUmNhaERWTUVIcm1nU28vMHZaZVVwbThlYWlBOXdZcXM3VlU3VXpZLzlYd3Nybmh3djFaUlNBCllJWVorcHZEZkI0WlJiYnRpLzU0aW1obGJNRGwrQ3NhcDBOSzU2WW0veU1UdUUzQjVtckhBMzNzRWNWSUQ0Qy8KTzM5bXZweWN4cnJjWDVnK2tON0lBcjVVZlVkcVVjYndycUx6eDVDdVhRbkt5eVdFNjFTdlBGcUZtQVdtS25NawozdUszSGJzNk9HNkx5RDlFZk15dEQxZnpMS2dZUEdnak85dGJyV2pEUzhWSDBGNU14YWgvNzVVRURkelFQOWhoCkY2NktUdVVxVElOcXI4UUFvK29leUxCVDU5dGk3Q3BCZ20rNWpSbElodzBoTklGck5uR250RVNTODRlaXo4cU4Ka0xSd2VLVUNnZ0VBTzd4WWJNY2UwbEhYVmdYTmdZeGxVanNOazFwZkc1bGRGWE5Zb3FBM1RTaXlGdXVRRzZCdQo2K2hMa1BMWTFqL0F5eGdaVU1WQ0xyS1J0dnlOK1A2SWtPK2s2TUVUWnQ3M0J1cVYyWkhpelc0T1RmaVhpVWFsClRoYkVRVjZ3ZW9XQlpJenNEM3JxeTcyUUp0eUZqZm5IT3h6OXpSZDVvRFZYM3gyWkwwWTF5NjV4RDArUmczc3AKT05lRG1vcXdXZWMxS1BNZDIwWldDdXB0alUxcHBDQU1GdTdMd2Q3K3M5R1JzZUZTeXhuWTFydWhLMHRPcE5kNAovVmF4NE1wUkJvVkJwd2RyM3VzL1hBQWlaMElsdU5WTFB4UEptdHQ1UTI2Y2JWYXdwYWVSNnRyNlVvSlBMaVpiClR2M0dlUnUvZFlPQzJNYjFnV3RCZXM2Z3FmWVU5KzNzYVFLQ0FRQm5aV0lRUlZMNDRseUprSXAvRHV2aEpiYkQKSjZFeXNXZjRoZlZJUUZ2R0pmV0I5eWhFcVZ3K0UzZmtnWTF5MnlibjNtTDBnQVFwcUVXV1dLQ2xaKzVnZEk1ZgoyZ3ZqTjYzYUFjdkRUZDVSL2dDSnFERzg1dG5DckdRVStFdlRhRUtIOXdxV2FXc3hmdGhnaUU0YnlhMWo3Q1ZwClAwRzlIZU5yaFRhT0NoV09Idjh2ZnBHWjJEN2FER3ZjUGZpVWk0LzhsNDkzVXdRQ29aZFBpSjhacXVLU0dVS3MKOERuL0JOT0hIM3pRVVRhUmxzb0tRV2dvNXFsS3pmS0w5NklOdlRpTkRZYzRlbnY5K0xsbUNFbllUSWtWd1RPSApnZHR2T1lhdFZzbmNQWlB4NkVzcE1HNG9nUEJET1BKSnNTRVNodjBuUVE3WHZ5QWxrbTJhK2ZWbHhqT1UKLS0tLS1FTkQgUlNBIFBSSVZBVEUgS0VZLS0tLS0K
```


Value is long output of command shared in the previous step (without trailing `%`)

- Push secret to semaphore

    ```
    sem create -f secret_with_private_ssh_key.yml
    ```

- Verify that secret is in place

    ```
    sem get secrets
    sem describe secrets ssh-key-example-repo
    ```

### Adjust Semaphore commands

- Decode secret with the following command in Semaphore yaml

   ```
   echo $SSH_KEY | base64 --decode > ~/.ssh/id_rsa_example_repo
   ```

- Add key to agent with the following commands in the Semaphore yaml file

    ```
    chmod 600 ~/.ssh/id_rsa_example_repo
    ssh-add ~/.ssh/id_rsa_example_repo
    ```
- Load secret in job by adding the following lines to yaml file

    ```
    secrets:
      - name: ssh-key-example-repo
    ```



## Additional info

At the moment, an existing secret can not be updated, so it is necessary to
delete it and create new one.

```
$ sem delete secret <secret-name>
$ sem create -f <local-path-of-the-secret>
```
